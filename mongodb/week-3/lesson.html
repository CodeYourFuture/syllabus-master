
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Week 3 - Advanced MongoDB Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-prism/prism-tomorrow.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../../finalproject/intro.html" />
    
    
    <link rel="prev" href="../week-2/lesson.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Course</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Before you start
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../../others/lesson0.html">
            
                <a href="../../others/lesson0.html">
            
                    
                    Week 0 - Introduction and basic setup
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../../html-css/">
            
                <a href="../../html-css/">
            
                    
                    HTML/CSS
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../../html-css/week-1/lesson.html">
            
                <a href="../../html-css/week-1/lesson.html">
            
                    
                    Week 1 - Semantic HTML and CSS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../../html-css/week-2/lesson.html">
            
                <a href="../../html-css/week-2/lesson.html">
            
                    
                    Week 2 - Responsive Web and layout
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../../html-css/week-3/lesson.html">
            
                <a href="../../html-css/week-3/lesson.html">
            
                    
                    Week 3 - Design frameworks, Naming patterns and Forms
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../../js-core-1/">
            
                <a href="../../js-core-1/">
            
                    
                    JavaScript I
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../../js-core-1/week-1/lesson.html">
            
                <a href="../../js-core-1/week-1/lesson.html">
            
                    
                    Week 1 - Hello JavaScript
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../../js-core-1/week-2/lesson.html">
            
                <a href="../../js-core-1/week-2/lesson.html">
            
                    
                    Week 2 - Conditionals and Arrays
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../../js-core-1/week-3/lesson.html">
            
                <a href="../../js-core-1/week-3/lesson.html">
            
                    
                    Week 3 - More Arrays
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../../js-core-2/">
            
                <a href="../../js-core-2/">
            
                    
                    JavaScript II
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../../js-core-2/week-1/lesson.html">
            
                <a href="../../js-core-2/week-1/lesson.html">
            
                    
                    Week 1 - Objects
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../../js-core-2/week-2/lesson.html">
            
                <a href="../../js-core-2/week-2/lesson.html">
            
                    
                    Week 2 - JS in the Browser
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../../js-core-2/week-3/lesson.html">
            
                <a href="../../js-core-2/week-3/lesson.html">
            
                    
                    Week 3 - Asynchronous and The Web
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../../js-core-3/">
            
                <a href="../../js-core-3/">
            
                    
                    JavaScript III
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../../js-core-3/week-1/lesson.html">
            
                <a href="../../js-core-3/week-1/lesson.html">
            
                    
                    Week 1 - Debugging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../../js-core-3/week-2/lesson.html">
            
                <a href="../../js-core-3/week-2/lesson.html">
            
                    
                    Week 2 - APIs and Fetch
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../../js-core-3/week-3/lesson.html">
            
                <a href="../../js-core-3/week-3/lesson.html">
            
                    
                    Week 3 - Scope and ES6
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../../react/">
            
                <a href="../../react/">
            
                    
                    React
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../../react/week-1/lesson.html">
            
                <a href="../../react/week-1/lesson.html">
            
                    
                    Week 1 - React 101
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../../react/week-2/lesson.html">
            
                <a href="../../react/week-2/lesson.html">
            
                    
                    Week 2 - Reacting to Changes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../../react/week-3/lesson.html">
            
                <a href="../../react/week-3/lesson.html">
            
                    
                    Week 3 - Fetching Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../../react/week-4/lesson.html">
            
                <a href="../../react/week-4/lesson.html">
            
                    
                    Routing (optional)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="../../react/classes-optional/lesson.html">
            
                <a href="../../react/classes-optional/lesson.html">
            
                    
                    Class components (optional)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../../node/">
            
                <a href="../../node/">
            
                    
                    Node
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../../node/week-1/lesson.html">
            
                <a href="../../node/week-1/lesson.html">
            
                    
                    Week 1 - Node and Express 101
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../../node/week-2/lesson.html">
            
                <a href="../../node/week-2/lesson.html">
            
                    
                    Week 2 - Middleware, Templating and APIs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../../node/week-3/lesson.html">
            
                <a href="../../node/week-3/lesson.html">
            
                    
                    Week 3 - Advanced Node
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../../db/">
            
                <a href="../../db/">
            
                    
                    SQL Databases
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../../db/week-1/lesson.html">
            
                <a href="../../db/week-1/lesson.html">
            
                    
                    Week 1 - Introduction to SQL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="../../db/week-2/lesson.html">
            
                <a href="../../db/week-2/lesson.html">
            
                    
                    Week 2 - More SQL and integration with NodeJS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="../../db/week-3/lesson.html">
            
                <a href="../../db/week-3/lesson.html">
            
                    
                    Week 3 - More integration with NodeJS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../">
            
                <a href="../">
            
                    
                    MongoDB
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="../week-1/lesson.html">
            
                <a href="../week-1/lesson.html">
            
                    
                    Week 1 - Introduction to MongoDB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="../week-2/lesson.html">
            
                <a href="../week-2/lesson.html">
            
                    
                    Week 2 - More MongoDB
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.10.3" data-path="lesson.html">
            
                <a href="lesson.html">
            
                    
                    Week 3 - Advanced MongoDB
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../../finalproject/intro.html">
            
                <a href="../../finalproject/intro.html">
            
                    
                    Final Project
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="../../finalproject/intro.html">
            
                <a href="../../finalproject/intro.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="../../finalproject/roles.html">
            
                <a href="../../finalproject/roles.html">
            
                    
                    Roles
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="../../finalproject/firstweek.html">
            
                <a href="../../finalproject/firstweek.html">
            
                    
                    First Week
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.4" data-path="../../finalproject/finalweek.html">
            
                <a href="../../finalproject/finalweek.html">
            
                    
                    Final Week
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Workshops</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../../others/deployment/1-for-html-module/workshop-1-basic-automatic-deployment-with-netlify-mentor-notes.html">
            
                <a href="../../others/deployment/1-for-html-module/workshop-1-basic-automatic-deployment-with-netlify-mentor-notes.html">
            
                    
                    Deploying Code Workshop
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../../node/week-1/workshop.html">
            
                <a href="../../node/week-1/workshop.html">
            
                    
                    Express Workshop
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../../node/week-3/workshop.html">
            
                <a href="../../node/week-3/workshop.html">
            
                    
                    Hotel Workshop
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../../others/aws-workshop-2.html">
            
                <a href="../../others/aws-workshop-2.html">
            
                    
                    AWS & DynamoDB Workshop
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../../others/git-desktop-workshop.html">
            
                <a href="../../others/git-desktop-workshop.html">
            
                    
                    Github Desktop Workshop
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Guides</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../../html-css/compile-scss-instructions.html">
            
                <a href="../../html-css/compile-scss-instructions.html">
            
                    
                    Compiling SCSS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../../others/coding-101.html">
            
                <a href="../../others/coding-101.html">
            
                    
                    Coding 101
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../../others/react-cheatsheet.html">
            
                <a href="../../others/react-cheatsheet.html">
            
                    
                    React Cheatsheet
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Modules</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../../others/java.html">
            
                <a href="../../others/java.html">
            
                    
                    Java Module
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../../others/mongodb-101.html">
            
                <a href="../../others/mongodb-101.html">
            
                    
                    MongoDB Module
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">For Students</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../../others/coding-standards.html">
            
                <a href="../../others/coding-standards.html">
            
                    
                    Coding Standards and Best Practices
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">For Teachers</li>
        
        
    
        <li class="chapter " data-level="6.1" >
            
                <span>
            
                    
                    Teaching Notes
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.1.1" data-path="../../html-css/week-1/mentors.html">
            
                <a href="../../html-css/week-1/mentors.html">
            
                    
                    HTML/CSS - Week 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.2" data-path="../../html-css/week-2/mentors.html">
            
                <a href="../../html-css/week-2/mentors.html">
            
                    
                    HTML/CSS - Week 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.3" data-path="../../html-css/week-3/mentors.html">
            
                <a href="../../html-css/week-3/mentors.html">
            
                    
                    HTML/CSS - Week 3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.4" data-path="../../js-core-1/week-1/mentors.html">
            
                <a href="../../js-core-1/week-1/mentors.html">
            
                    
                    JavaScript I - Week 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.5" data-path="../../js-core-1/week-2/mentors.html">
            
                <a href="../../js-core-1/week-2/mentors.html">
            
                    
                    JavaScript I - Week 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.6" data-path="../../js-core-1/week-3/mentors.html">
            
                <a href="../../js-core-1/week-3/mentors.html">
            
                    
                    JavaScript I - Week 3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.7" data-path="../../js-core-2/week-1/mentors.html">
            
                <a href="../../js-core-2/week-1/mentors.html">
            
                    
                    JavaScript II - Week 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.8" data-path="../../js-core-2/week-2/mentors.html">
            
                <a href="../../js-core-2/week-2/mentors.html">
            
                    
                    JavaScript II - Week 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.9" data-path="../../js-core-2/week-3/mentors.html">
            
                <a href="../../js-core-2/week-3/mentors.html">
            
                    
                    JavaScript II - Week 3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.10" data-path="../../js-core-3/week-1/mentors.html">
            
                <a href="../../js-core-3/week-1/mentors.html">
            
                    
                    JavaScript III - Week 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.11" data-path="../../js-core-3/week-2/mentors.html">
            
                <a href="../../js-core-3/week-2/mentors.html">
            
                    
                    JavaScript III - Week 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.12" data-path="../../js-core-3/week-3/mentors.html">
            
                <a href="../../js-core-3/week-3/mentors.html">
            
                    
                    JavaScript III - Week 3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.13" data-path="../../react/week-1/mentors.html">
            
                <a href="../../react/week-1/mentors.html">
            
                    
                    React - Week 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.14" data-path="../../react/week-2/mentors.html">
            
                <a href="../../react/week-2/mentors.html">
            
                    
                    React - Week 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.15" data-path="../../react/week-3/mentors.html">
            
                <a href="../../react/week-3/mentors.html">
            
                    
                    React - Week 3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.16" data-path="../../node/week-1/mentors.html">
            
                <a href="../../node/week-1/mentors.html">
            
                    
                    Node - Week 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.17" data-path="../../node/week-2/mentors.html">
            
                <a href="../../node/week-2/mentors.html">
            
                    
                    Node - Week 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.18" data-path="../../node/week-3/mentors.html">
            
                <a href="../../node/week-3/mentors.html">
            
                    
                    Node - Week 3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.19" data-path="../../db/week-1/mentors.html">
            
                <a href="../../db/week-1/mentors.html">
            
                    
                    Databases - Week 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.20" data-path="../../db/week-2/mentors.html">
            
                <a href="../../db/week-2/mentors.html">
            
                    
                    Databases - Week 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.21" data-path="../../db/week-3/mentors.html">
            
                <a href="../../db/week-3/mentors.html">
            
                    
                    Databases - Week 3
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Week 3 - Advanced MongoDB</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <p><img src="https://img.shields.io/badge/status-review-orange.svg" alt="Lesson in review"></p>
<h1 id="mongodb---3">MongoDB - 3</h1>
<hr>
<p><strong>Teaching this lesson?</strong></p>
<p>Read the Mentors Notes <a href="mentors.md">here</a></p>
<hr>
<h1 id="lesson-3">Lesson 3</h1>
<p>Outline:</p>
<ul>
<li>Lesson 2 review</li>
<li>Indexing<ul>
<li>indexing a collection</li>
<li>indexing a collection using a collated index</li>
<li>implementing full text search in MongoDB</li>
</ul>
</li>
<li>Role based authentication<ul>
<li>cluster based roles</li>
<li>backup and restoration roles</li>
</ul>
</li>
<li>Aggregation</li>
<li>Replication</li>
<li>Transactions</li>
<li>A project in MongoDB</li>
<li>Next steps</li>
</ul>
<h2 id="review">Review</h2>
<p>In the last lesson, we learned</p>
<ul>
<li>Signing up for MongoDB Atlas</li>
<li>Making a local Express server</li>
<li>Connecting to a MongoDB server from a local Node server</li>
<li>Creating and dropping databases and collections in Atlas</li>
<li>Reading documentation</li>
<li>BSON types</li>
<li>Creating documents</li>
<li>Creating a document in Atlas</li>
<li>Creating a document with the MongoDB Node Driver</li>
<li>Updating a document</li>
<li>Deleting a document</li>
</ul>
<p>Now that we know how to read databases, collections, and documents, we are ready to move on to more advanced tasks.</p>
<h3 id="use-the-sample-database-in-mongodb-atlas">Use the sample database in MongoDB Atlas</h3>
<p>We are going to use the sample cluster that we have already connected to in MongoDB Atlas.</p>
<p>Let&apos;s use the Atlas GUI to:</p>
<ol>
<li>create a new database</li>
<li>create a new collection</li>
<li>import sample data (we are interested in the AirBnB listings and reviews sample database)</li>
</ol>
<p>We now have a pretty extensive dataset that we will use for the rest of the class.</p>
<h3 id="insert-a-document-with-accent">Insert a document with accent</h3>
<p>The first task here is to insert a document in sample_airbnb.listingsAndReviews with the following fields found <a href="fields.js">here</a>.</p>
<p>You can use the code that we developed in lesson 2, or the GUI Hint: you can use clone in GUI</p>
<p>This document is useful for the next tasks.</p>
<h2 id="indexing">Indexing</h2>
<p>Let&apos;s start by visiting the official documentation: <a href="https://docs.mongodb.com/manual/indexes/" target="_blank">https://docs.mongodb.com/manual/indexes/</a></p>
<p>The most interesting index properties are:</p>
<ul>
<li><p>Default id index</p>
</li>
<li><p>Let&apos;s take a look in the indexes that we have in Atlas GUI sample database.</p>
</li>
<li><p>Index Types</p>
</li>
<li><p>Index Properties</p>
</li>
<li><p>Collation</p>
</li>
<li><p>Covered queries</p>
</li>
</ul>
<h3 id="create-an-index">Create an index</h3>
<p>Let&apos;s create a new index using the Atlas GUI.</p>
<p><strong>Index prefixing and how it affects querying</strong></p>
<h3 id="create-a-collated-index">Create a collated index</h3>
<p>From the documentation: &quot;Collation allows users to specify language-specific rules for string comparison, such as rules for lettercase and accent marks.&quot;</p>
<p>In our case, we have inserted a document with french accents, so we want to create an index that will take it into account.</p>
<p>To create a collated index supporting the French language in the shell we would: <code>db.listingsAndReviews.createIndex( { name: 1 }, { collation: { locale: &quot;fr&quot; } } )</code></p>
<p>Now, let&apos;s do the same using the Atlas GUI.</p>
<h3 id="implementing-full-text-search-using-mongodb">Implementing full text search using MongoDB</h3>
<p>One of the special types of indexes is the text index.</p>
<p>To create a text index in the shell: <code>db.listingsAndReviews.createIndex( { name: &quot;text&quot;, summary: &quot;text&quot; } )</code></p>
<p>Now, let&apos;s do the same using the Atlas GUI.</p>
<h4 id="exercise">Exercise</h4>
<p>Search for the document using the index.</p>
<p>How can we be sure that we use the index? Can we create a covered query?</p>
<p>Hint: <code>db.collection.find().explain()</code></p>
<h2 id="role-based-authentication">Role based authentication</h2>
<p>Built in roles: <em> read </em> readWrite <em> dbAdmin </em> dbOwner * userAdmin</p>
<h3 id="cluster-based-roles">Cluster based roles</h3>
<ul>
<li>clusterAdmin</li>
<li>clusterManager</li>
<li>clusterMonitor</li>
</ul>
<h3 id="backup-and-restoration-roles">Backup and restoration roles</h3>
<ul>
<li>backup</li>
<li>restore</li>
</ul>
<p>... many more</p>
<p>Let&apos;s update our MongoDB Atlas database to use roles.</p>
<p>First, we are going to add a built in role using the MongoDB Atlas.</p>
<p>Now, let&apos;s add a custom, read only in AirBnB DB role using the MongoDB Atlas.</p>
<h3 id="aggregation">Aggregation</h3>
<p>Why aggregation framework?</p>
<p>Aggregation framework in MongoDB is modelled after the familiar concept of data processing pipelines. Documents enter the pipeline with the MongoDB structure and exit the other end transformed into BSON documents with calculated fields. Commands in a pipeline are executed sequentially and in the order that they appear in the array [].</p>
<p>There are 3 ways to perform aggregation in MongoDB: 1. Aggregation pipeline 2. Map-reduce function 3. Single purpose aggregation methods</p>
<p>In this module, we will focus on the aggregation pipeline.</p>
<p>Some of the most important operators and how they relate with Structured Query Language (SQL):</p>
<table>
<thead>
<tr>
<th>SQL</th>
<th>Aggregation framework</th>
</tr>
</thead>
<tbody>
<tr>
<td>WHERE / HAVING</td>
<td>$match</td>
</tr>
<tr>
<td>GROUP BY</td>
<td>$group</td>
</tr>
<tr>
<td>SELECT</td>
<td>$project</td>
</tr>
<tr>
<td>ORDER BY</td>
<td>$sort</td>
</tr>
<tr>
<td>LIMIT</td>
<td>$limit</td>
</tr>
<tr>
<td>sum() / count()</td>
<td>$sum</td>
</tr>
<tr>
<td>average()</td>
<td>$avg</td>
</tr>
<tr>
<td>join</td>
<td>$lookup</td>
</tr>
</tbody>
</table>
<pre class="language-"><code class="lang-js">db<span class="token punctuation">.</span>listingsAndReviews<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> $match<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token punctuation">{</span> $regex<span class="token operator">:</span> <span class="token regex">/^aA/</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> $group<span class="token operator">:</span> <span class="token punctuation">{</span> _id<span class="token operator">:</span> <span class="token string">&quot;$name&quot;</span><span class="token punctuation">,</span> average<span class="token operator">:</span> <span class="token punctuation">{</span> $avg<span class="token operator">:</span> <span class="token string">&quot;$price&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> $sort<span class="token operator">:</span> <span class="token punctuation">{</span> average<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> $project<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> average<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>What does the pipeline above do?</p>
<ol>
<li>matches all documents with a name starting from aA</li>
<li>groups them by average price</li>
<li>sorts them by average price</li>
<li>projects(selects) name and average price in the output</li>
</ol>
<p>What&apos;s the output like?</p>
<pre class="language-"><code class="lang-js"><span class="token punctuation">{</span>_id<span class="token operator">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> average<span class="token operator">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre>
<p>More information: <a href="https://docs.mongodb.com/manual/aggregation/" target="_blank">https://docs.mongodb.com/manual/aggregation/</a></p>
<h4 id="exercise">Exercise:</h4>
<p>Now, let&apos;s do the same using the Atlas GUI.</p>
<h2 id="replication">Replication</h2>
<p>Replication in MongoDB is used to increase redundancy and data availability. In its essence it&apos;s a way for 3 or more (or even 2 with some caveats..) servers to keep the same copy of data.</p>
<p><img src="assets/operations.png" alt="replication diagram"></p>
<p>Writes always go to the primary and get propagated <em>asynchronously</em> to the secondaries.</p>
<p>Reads can go to the primary or any of the secondaries.</p>
<p>Election process:</p>
<p>Replica sets implement by default automatic failover. If a primary server fails, the remaining secondaries will elect the new primary. This will by default be the secondary that is most &quot;up to date&quot; with the primary but we can affect (rig) the election process by assigning different votes to each server.</p>
<p>More information: <a href="https://docs.mongodb.com/manual/core/replica-set-elections/" target="_blank">https://docs.mongodb.com/manual/core/replica-set-elections/</a></p>
<p>Using replication we can perform a few interesting tasks:</p>
<ul>
<li>delayed replica for backup. Delay backups by an hour, enabling us to recover from dropping a database in production</li>
<li>hidden replicas for reporting. These replicas will never become primaries so we can safely apply read load to them for reporting purposes</li>
<li>replicas in different location for disaster recovery</li>
<li>replicas in different location to be closer to our users</li>
</ul>
<h2 id="transactions">Transactions</h2>
<p>MongoDB introduced multi-document ACID transactions in version 4.0 which was released on July 2018. Transactions are an integral part of relational databases. Every RDBMS from the very early days relied on transactions to achieve Atomicity, Consistency, Isolation and Durability. Getting these in a non-relational database is a breakthrough that can fundamentally change the way developers and database architects design software systems.</p>
<h3 id="acid">ACID</h3>
<p>Atomicity refers to the concept that a transactions needs to be atomic. It either successes and its results are visible to every subsequent user reading them or it fails and every change is rolled back to the point it was right before it started. It&apos;s either that all actions in a transaction occur or nothing at all.</p>
<p>Consistency refers to the database always being in a consistent state. Every database operation may complete successfully, fail or abort but in any case in the end our database must be in a state that its data is consistent.</p>
<p>Isolation refers to the visibility of transaction operations to other operations happening in parallel.</p>
<p>Durability in relational database systems refers to the property that every transaction that has successfully committed will survive in the face of failure. This usually refers to writing the contents of the committed transaction in persistent storage (hard disk or SDD).</p>
<p>Let&apos;s create a new database <code>mongo_bank</code> with a collection <code>accounts</code>:</p>
<p><code>{&quot;collection&quot;: &quot;accounts&quot;, &quot;account_id&quot;: &quot;1&quot;, &quot;account_name&quot;: &quot;Alex&quot;, &quot;account_balance&quot;:100}</code></p>
<p><code>{&quot;collection&quot;: &quot;accounts&quot;, &quot;account_id&quot;: &quot;2&quot;, &quot;account_name&quot;: &quot;Mary&quot;, &quot;account_balance&quot;:50}</code></p>
<p>This way, we have 2 users with accounts in our bank.</p>
<p>We can now transfer money between th accounts. We will do this using the Mongo shell:</p>
<pre class="language-"><code class="lang-js">session <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">getMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span> readPreference<span class="token operator">:</span> <span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">&quot;primary&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

accountsCollection <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token string">&quot;mongo_bank&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>accounts<span class="token punctuation">;</span>

session<span class="token punctuation">.</span><span class="token function">startTransaction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  readConcern<span class="token operator">:</span> <span class="token punctuation">{</span> level<span class="token operator">:</span> <span class="token string">&quot;snapshot&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  writeConcern<span class="token operator">:</span> <span class="token punctuation">{</span> w<span class="token operator">:</span> <span class="token string">&quot;majority&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  accountsCollection<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> account_id<span class="token operator">:</span> <span class="token string">&quot;1&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> $inc<span class="token operator">:</span> <span class="token punctuation">{</span> account_balance<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">70</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  accountsCollection<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> account_id<span class="token operator">:</span> <span class="token string">&quot;2&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> $inc<span class="token operator">:</span> <span class="token punctuation">{</span> account_balance<span class="token operator">:</span> <span class="token number">70</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;error:&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
source_balance <span class="token operator">=</span> accountsCollection<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> account_id<span class="token operator">:</span> <span class="token string">&quot;1&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>account_balance<span class="token punctuation">;</span>
target_balance <span class="token operator">=</span> accountsCollection<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> account_id<span class="token operator">:</span> <span class="token string">&quot;2&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>account_balance<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>source_balance <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> target_balance <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  session<span class="token punctuation">.</span><span class="token function">abortTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
session<span class="token punctuation">.</span><span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
session<span class="token punctuation">.</span><span class="token function">endSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>To which the output should be similar to:</p>
<pre class="language-"><code class="lang-js"><span class="token function">WriteCommandError</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  errorLabels<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;TransientTransactionError&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  operationTime<span class="token operator">:</span> <span class="token function">Timestamp</span><span class="token punctuation">(</span><span class="token number">1561207870</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  ok<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  errmsg<span class="token operator">:</span> <span class="token string">&quot;Transaction 0 has been aborted.&quot;</span><span class="token punctuation">,</span>
  code<span class="token operator">:</span> <span class="token number">251</span><span class="token punctuation">,</span>
  codeName<span class="token operator">:</span> <span class="token string">&quot;NoSuchTransaction&quot;</span><span class="token punctuation">,</span>
  $clusterTime<span class="token operator">:</span> <span class="token punctuation">{</span>
    clusterTime<span class="token operator">:</span> <span class="token function">Timestamp</span><span class="token punctuation">(</span><span class="token number">1561207870</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    signature<span class="token operator">:</span> <span class="token punctuation">{</span>
      hash<span class="token operator">:</span> <span class="token function">BinData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;1x7oLuNzWehAWylVA/E9tdXLuFA=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      keyId<span class="token operator">:</span> <span class="token function">NumberLong</span><span class="token punctuation">(</span><span class="token string">&quot;6655324027294318593&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Database operations need to be inside our session if we want to benefit from transactions</p>
<h3 id="exercise">Exercise</h3>
<p>Transfer 40 monads from account 1 to account 2. Observe how it works perfectly fine.</p>
<h2 id="mongodb-project">MongoDB Project</h2>
<p>Based on the data from the AirBnB listings and reviews collection, we want to create a front end for it.</p>
<p>Functions:</p>
<ol>
<li>Search for rooms by name or summary</li>
<li>Filter by price</li>
<li>Show the top superhosts in the page. On click through, show a list of their apartments</li>
</ol>
<p>You can use Node/Express and the Aggregation framework if you see fit.</p>
<p>Please use this index.html file as a starting point: <a href="https://github.com/agiamas/cyf-mongodb-2019/blob/master/index.html" target="_blank">https://github.com/agiamas/cyf-mongodb-2019/blob/master/index.html</a></p>
<h2 id="next-steps">Next Steps</h2>
<p>If you have time and interest, please register to either of these classes or any other class in MongoDB university. All classes are free and on average require 6-10 hours of time per week.</p>
<p><a href="https://university.mongodb.com/courses/M220JS/about" target="_blank">https://university.mongodb.com/courses/M220JS/about</a></p>
<p><a href="https://university.mongodb.com/courses/M220P/about" target="_blank">https://university.mongodb.com/courses/M220P/about</a></p>
<p>Shameless plug(s)</p>
<p>I am also the author of the Mastering MongoDB 4.X book by Packt publishing, available <a href="https://www.amazon.co.uk/Mastering-MongoDB-4-x-high-fault-tolerant/dp/1789617871" target="_blank">here</a>.</p>
<p>As a member of the #runningclub at DIT we have decided to put our Monday night running club efforts to good use by raising money for Cancer Research UK, so a few of us are doing the 10k Race for Life in Hyde Park at the end of July.</p>
<p>If you would like to contribute, please do so here: <a href="https://fundraise.cancerresearchuk.org/page/alexs-race-for-life-3725" target="_blank">https://fundraise.cancerresearchuk.org/page/alexs-race-for-life-3725</a></p>
<p>All donations are eligible for Gift Aid.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../week-2/lesson.html" class="navigation navigation-prev " aria-label="Previous page: Week 2 - More MongoDB">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../../finalproject/intro.html" class="navigation navigation-next " aria-label="Next page: Final Project">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Week 3 - Advanced MongoDB","level":"1.10.3","depth":2,"next":{"title":"Final Project","level":"1.11","depth":1,"path":"finalproject/intro.md","ref":"finalproject/intro.md","articles":[{"title":"Introduction","level":"1.11.1","depth":2,"path":"finalproject/intro.md","ref":"finalproject/intro.md","articles":[]},{"title":"Roles","level":"1.11.2","depth":2,"path":"finalproject/roles.md","ref":"finalproject/roles.md","articles":[]},{"title":"First Week","level":"1.11.3","depth":2,"path":"finalproject/firstweek.md","ref":"finalproject/firstweek.md","articles":[]},{"title":"Final Week","level":"1.11.4","depth":2,"path":"finalproject/finalweek.md","ref":"finalproject/finalweek.md","articles":[]}]},"previous":{"title":"Week 2 - More MongoDB","level":"1.10.2","depth":2,"path":"mongodb/week-2/lesson.md","ref":"mongodb/week-2/lesson.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["prism","-highlight"],"pluginsConfig":{"prism":{"css":["prismjs/themes/prism-tomorrow.css"]},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"mongodb/week-3/lesson.md","mtime":"2020-06-25T22:40:39.353Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-06-25T22:41:23.995Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

